{% extends "base.html" %}

{% block title %}Project Manager - AI Game Studio{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h2">
                <i data-feather="folder" class="me-2"></i>
                Project Manager
            </h1>
            <div class="btn-group">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newProjectModal">
                    <i data-feather="plus" class="me-2"></i>
                    New Project
                </button>
                <button type="button" class="btn btn-outline-secondary" onclick="refreshProjects()">
                    <i data-feather="refresh-cw" class="me-2"></i>
                    Refresh
                </button>
            </div>
        </div>
        
        <!-- Project Stats -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i data-feather="folder" class="text-primary" style="width: 32px; height: 32px;"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fs-2 fw-bold" id="totalProjects">0</div>
                                <div class="text-muted">Total Projects</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i data-feather="box" class="text-success" style="width: 32px; height: 32px;"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fs-2 fw-bold" id="totalAssets">0</div>
                                <div class="text-muted">Total Assets</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i data-feather="code" class="text-info" style="width: 32px; height: 32px;"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fs-2 fw-bold" id="totalScripts">0</div>
                                <div class="text-muted">Scripts</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0">
                                <i data-feather="map" class="text-warning" style="width: 32px; height: 32px;"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <div class="fs-2 fw-bold" id="totalEnvironments">0</div>
                                <div class="text-muted">Environments</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Projects Grid -->
        <div id="projectsContainer">
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3 text-muted">Loading projects...</p>
            </div>
        </div>
    </div>
</div>

<!-- New Project Modal -->
<div class="modal fade" id="newProjectModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Project</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newProjectForm" onsubmit="createProject(event)">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectName" class="form-label">Project Name</label>
                                <input type="text" class="form-control" id="projectName" required maxlength="255">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="projectType" class="form-label">Project Type</label>
                                <select class="form-select" id="projectType">
                                    <option value="general">General Game</option>
                                    <option value="roblox">Roblox Game</option>
                                    <option value="unity">Unity Project</option>
                                    <option value="unreal">Unreal Engine</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="projectDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="projectDescription" rows="3" 
                                  placeholder="Describe your game project..."></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Quick Start Template</label>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" 
                                            onclick="setProjectTemplate('platformer')">
                                        <i data-feather="zap" class="me-1"></i>
                                        Platformer Game
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" 
                                            onclick="setProjectTemplate('rpg')">
                                        <i data-feather="sword" class="me-1"></i>
                                        RPG Adventure
                                    </button>
                                    <button type="button" class="btn btn-outline-primary btn-sm" 
                                            onclick="setProjectTemplate('racing')">
                                        <i data-feather="truck" class="me-1"></i>
                                        Racing Game
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">AI Generation Options</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="generateBasicAssets" checked>
                                    <label class="form-check-label" for="generateBasicAssets">
                                        Generate basic game assets
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="generateScripts" checked>
                                    <label class="form-check-label" for="generateScripts">
                                        Generate starter scripts
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="generateEnvironment">
                                    <label class="form-check-label" for="generateEnvironment">
                                        Generate game world
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i data-feather="plus" class="me-1"></i>
                        Create Project
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Project Detail Modal -->
<div class="modal fade" id="projectDetailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="projectDetailTitle">Project Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="projectDetailContent">
                    <div class="text-center py-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentProjects = [];

document.addEventListener('DOMContentLoaded', function() {
    loadProjects();
    
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
});

function loadProjects() {
    fetch('/api/projects')
        .then(response => response.json())
        .then(projects => {
            currentProjects = projects;
            displayProjects(projects);
            updateStats(projects);
        })
        .catch(error => {
            console.error('Error loading projects:', error);
            document.getElementById('projectsContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i data-feather="alert-circle" class="me-2"></i>
                    Error loading projects. Please try again.
                </div>
            `;
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        });
}

function displayProjects(projects) {
    const container = document.getElementById('projectsContainer');
    
    if (projects.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i data-feather="folder-plus" style="width: 64px; height: 64px;" class="text-muted mb-3"></i>
                <h4>No Projects Yet</h4>
                <p class="text-muted">Create your first game project to get started!</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newProjectModal">
                    <i data-feather="plus" class="me-2"></i>
                    Create Your First Project
                </button>
            </div>
        `;
    } else {
        const projectsGrid = projects.map(project => `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card h-100 project-card" onclick="openProject(${project.id})">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5 class="card-title mb-0">${escapeHtml(project.name)}</h5>
                            <span class="badge bg-${getProjectTypeBadgeColor(project.project_type)}">${project.project_type}</span>
                        </div>
                        
                        <p class="card-text text-muted small mb-3">${escapeHtml(project.description || 'No description')}</p>
                        
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <div class="fs-5 fw-bold text-primary">${project.asset_count || 0}</div>
                                <small class="text-muted">Assets</small>
                            </div>
                            <div class="col-4">
                                <div class="fs-5 fw-bold text-success">${project.script_count || 0}</div>
                                <small class="text-muted">Scripts</small>
                            </div>
                            <div class="col-4">
                                <div class="fs-5 fw-bold text-warning">${project.environment_count || 0}</div>
                                <small class="text-muted">Worlds</small>
                            </div>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="badge bg-${getStatusBadgeColor(project.status)}">${project.status}</span>
                            <small class="text-muted">${formatDate(project.updated_at)}</small>
                        </div>
                    </div>
                    
                    <div class="card-footer bg-transparent">
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="event.stopPropagation(); openProject(${project.id})">
                                <i data-feather="eye" class="me-1"></i>
                                View
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); exportProject(${project.id})">
                                <i data-feather="download" class="me-1"></i>
                                Export
                            </button>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" onclick="event.stopPropagation()" 
                                        data-bs-toggle="dropdown">
                                    <i data-feather="more-horizontal"></i>
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="editProject(${project.id})">
                                        <i data-feather="edit" class="me-2"></i>Edit
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="duplicateProject(${project.id})">
                                        <i data-feather="copy" class="me-2"></i>Duplicate
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item text-danger" href="#" onclick="deleteProject(${project.id})">
                                        <i data-feather="trash-2" class="me-2"></i>Delete
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = `<div class="row">${projectsGrid}</div>`;
    }
    
    if (typeof feather !== 'undefined') {
        feather.replace();
    }
}

function updateStats(projects) {
    document.getElementById('totalProjects').textContent = projects.length;
    
    let totalAssets = 0;
    let totalScripts = 0;
    let totalEnvironments = 0;
    
    projects.forEach(project => {
        totalAssets += project.asset_count || 0;
        totalScripts += project.script_count || 0;
        totalEnvironments += project.environment_count || 0;
    });
    
    document.getElementById('totalAssets').textContent = totalAssets;
    document.getElementById('totalScripts').textContent = totalScripts;
    document.getElementById('totalEnvironments').textContent = totalEnvironments;
}

function createProject(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const projectData = {
        name: document.getElementById('projectName').value,
        description: document.getElementById('projectDescription').value,
        project_type: document.getElementById('projectType').value,
        generate_assets: document.getElementById('generateBasicAssets').checked,
        generate_scripts: document.getElementById('generateScripts').checked,
        generate_environment: document.getElementById('generateEnvironment').checked
    };
    
    // Disable form
    const submitBtn = event.target.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating...';
    submitBtn.disabled = true;
    
    fetch('/api/projects', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(projectData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.error) {
            throw new Error(result.error);
        }
        
        // Close modal and refresh projects
        const modal = bootstrap.Modal.getInstance(document.getElementById('newProjectModal'));
        modal.hide();
        
        // Reset form
        document.getElementById('newProjectForm').reset();
        
        // Refresh projects list
        loadProjects();
        
        // Show success message
        showNotification('Project created successfully!', 'success');
    })
    .catch(error => {
        console.error('Error creating project:', error);
        showNotification('Error creating project: ' + error.message, 'danger');
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

function openProject(projectId) {
    // Load project details
    fetch(`/api/projects/${projectId}`)
        .then(response => response.json())
        .then(project => {
            document.getElementById('projectDetailTitle').textContent = project.name;
            
            const content = `
                <div class="row">
                    <div class="col-md-8">
                        <h6>Project Information</h6>
                        <table class="table table-sm">
                            <tr><td><strong>Name:</strong></td><td>${escapeHtml(project.name)}</td></tr>
                            <tr><td><strong>Type:</strong></td><td><span class="badge bg-${getProjectTypeBadgeColor(project.project_type)}">${project.project_type}</span></td></tr>
                            <tr><td><strong>Status:</strong></td><td><span class="badge bg-${getStatusBadgeColor(project.status)}">${project.status}</span></td></tr>
                            <tr><td><strong>Created:</strong></td><td>${formatDate(project.created_at)}</td></tr>
                            <tr><td><strong>Updated:</strong></td><td>${formatDate(project.updated_at)}</td></tr>
                        </table>
                        
                        <h6 class="mt-4">Description</h6>
                        <p>${escapeHtml(project.description || 'No description provided')}</p>
                    </div>
                    
                    <div class="col-md-4">
                        <h6>Quick Actions</h6>
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary btn-sm" onclick="generateAssetForProject(${project.id})">
                                <i data-feather="plus" class="me-1"></i>
                                Generate Asset
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="generateScriptForProject(${project.id})">
                                <i data-feather="code" class="me-1"></i>
                                Generate Script
                            </button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="exportProject(${project.id})">
                                <i data-feather="download" class="me-1"></i>
                                Export Project
                            </button>
                        </div>
                        
                        <h6 class="mt-4">Project Stats</h6>
                        <div class="row text-center">
                            <div class="col-12 mb-2">
                                <div class="fs-4 fw-bold text-primary">${project.asset_count || 0}</div>
                                <small class="text-muted">3D Assets</small>
                            </div>
                            <div class="col-12 mb-2">
                                <div class="fs-4 fw-bold text-success">${project.script_count || 0}</div>
                                <small class="text-muted">Scripts</small>
                            </div>
                            <div class="col-12 mb-2">
                                <div class="fs-4 fw-bold text-warning">${project.environment_count || 0}</div>
                                <small class="text-muted">Environments</small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('projectDetailContent').innerHTML = content;
            
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
            
            const modal = new bootstrap.Modal(document.getElementById('projectDetailModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Error loading project details:', error);
            showNotification('Error loading project details', 'danger');
        });
}

function setProjectTemplate(template) {
    const templates = {
        platformer: {
            name: 'Platformer Adventure',
            description: 'A classic side-scrolling platformer game with jumping mechanics, collectibles, and enemies.',
            type: 'unity'
        },
        rpg: {
            name: 'RPG Adventure',
            description: 'A role-playing game with character progression, quests, and turn-based combat.',
            type: 'roblox'
        },
        racing: {
            name: 'Racing Game',
            description: 'A fast-paced racing game with multiple tracks, vehicles, and competitive gameplay.',
            type: 'unity'
        }
    };
    
    const templateData = templates[template];
    if (templateData) {
        document.getElementById('projectName').value = templateData.name;
        document.getElementById('projectDescription').value = templateData.description;
        document.getElementById('projectType').value = templateData.type;
    }
}

function refreshProjects() {
    loadProjects();
}

function exportProject(projectId) {
    window.location.href = `/api/projects/${projectId}/export`;
}

function deleteProject(projectId) {
    if (confirm('Are you sure you want to delete this project? This action cannot be undone.')) {
        fetch(`/api/projects/${projectId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(result => {
            if (result.error) {
                throw new Error(result.error);
            }
            
            loadProjects();
            showNotification('Project deleted successfully', 'success');
        })
        .catch(error => {
            console.error('Error deleting project:', error);
            showNotification('Error deleting project: ' + error.message, 'danger');
        });
    }
}

function generateAssetForProject(projectId) {
    window.location.href = `/generate?project_id=${projectId}`;
}

function generateScriptForProject(projectId) {
    // TODO: Implement script generation interface
    showNotification('Script generation interface coming soon!', 'info');
}

function getProjectTypeBadgeColor(type) {
    const colors = {
        'roblox': 'primary',
        'unity': 'success',
        'unreal': 'warning',
        'general': 'secondary'
    };
    return colors[type] || 'secondary';
}

function getStatusBadgeColor(status) {
    const colors = {
        'draft': 'secondary',
        'processing': 'warning',
        'completed': 'success',
        'failed': 'danger'
    };
    return colors[status] || 'secondary';
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// Add CSS for project cards
const style = document.createElement('style');
style.textContent = `
    .project-card {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .project-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}