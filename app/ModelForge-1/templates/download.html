{% extends "base.html" %}

{% block title %}Download 3D Model - AI 3D Generator{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <!-- Desktop App Downloads (shown when no job parameter) -->
        {% if not job %}
        <div class="card mb-4">
            <div class="card-header">
                <h2 class="card-title mb-0">
                    <i data-feather="download" class="me-2"></i>
                    Download Desktop Application
                </h2>
            </div>
            <div class="card-body">
                <p class="text-muted mb-4">
                    Download the ModelForge desktop application for offline 3D model generation with enhanced performance and security.
                </p>
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i data-feather="monitor" style="width: 48px; height: 48px;" class="text-primary"></i>
                                </div>
                                <h5 class="card-title">Windows (MSIX)</h5>
                                <p class="card-text text-muted small">
                                    Microsoft Store compatible package for Windows 10/11
                                </p>
                                <a href="https://github.com/your-repo/ModelForge/releases/latest/download/ModelForge-Setup.msix"
                                   class="btn btn-primary" target="_blank">
                                    <i data-feather="download" class="me-2"></i>
                                    Download MSIX
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i data-feather="monitor" style="width: 48px; height: 48px;" class="text-info"></i>
                                </div>
                                <h5 class="card-title">Windows (NSIS)</h5>
                                <p class="card-text text-muted small">
                                    Traditional installer for all Windows versions
                                </p>
                                <a href="https://github.com/your-repo/ModelForge/releases/latest/download/ModelForge-Setup.exe"
                                   class="btn btn-info" target="_blank">
                                    <i data-feather="download" class="me-2"></i>
                                    Download EXE
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i data-feather="smartphone" style="width: 48px; height: 48px;" class="text-success"></i>
                                </div>
                                <h5 class="card-title">macOS</h5>
                                <p class="card-text text-muted small">
                                    DMG installer for macOS systems
                                </p>
                                <a href="https://github.com/your-repo/ModelForge/releases/latest/download/ModelForge.dmg"
                                   class="btn btn-success" target="_blank">
                                    <i data-feather="download" class="me-2"></i>
                                    Download DMG
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i data-feather="cpu" style="width: 48px; height: 48px;" class="text-warning"></i>
                                </div>
                                <h5 class="card-title">Linux</h5>
                                <p class="card-text text-muted small">
                                    AppImage for Linux distributions
                                </p>
                                <a href="https://github.com/your-repo/ModelForge/releases/latest/download/ModelForge.AppImage"
                                   class="btn btn-warning" target="_blank">
                                    <i data-feather="download" class="me-2"></i>
                                    Download AppImage
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-info mt-4">
                    <div class="d-flex align-items-center">
                        <i data-feather="info" class="me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-1">Latest Release</h6>
                            <p class="mb-0 small">Version 1.0.0 - Released October 2025</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Job Status Card -->
        {% if job %}
        <div class="card mb-4">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h2 class="card-title mb-0">
                        <i data-feather="download" class="me-2"></i>
                        Download 3D Model
                    </h2>
                    <span class="badge bg-{{ 'success' if job.status == 'completed' else 'warning' if job.status == 'processing' else 'danger' if job.status == 'failed' else 'secondary' }}">
                        {{ job.status.title() }}
                    </span>
                </div>
            </div>
            <div class="card-body">
                <!-- Job Details -->
                <div class="mb-4">
                    <h5>Generation Details</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <strong>Job ID:</strong> {{ job.id }}
                        </div>
                        <div class="col-md-6">
                            <strong>Created:</strong> {{ job.created_at.strftime('%Y-%m-%d %H:%M:%S') if job.created_at else 'N/A' }}
                        </div>
                        {% if job.completed_at %}
                        <div class="col-md-6">
                            <strong>Completed:</strong> {{ job.completed_at.strftime('%Y-%m-%d %H:%M:%S') }}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Prompt Display -->
                <div class="mb-4">
                    <h5>
                        <i data-feather="type" class="me-2"></i>
                        Text Prompt
                    </h5>
                    <div class="bg-light p-3 rounded border">
                        <p class="mb-0">"{{ job.prompt }}"</p>
                    </div>
                </div>

                <!-- Reference Image -->
                {% if job.reference_image_path %}
                <div class="mb-4">
                    <h5>
                        <i data-feather="image" class="me-2"></i>
                        Reference Image
                    </h5>
                    <div class="border rounded p-3">
                        <img src="{{ url_for('static', filename='../uploads/' + job.reference_image_path.split('/')[-1]) }}" 
                             alt="Reference Image" 
                             class="img-fluid" 
                             style="max-height: 200px;">
                    </div>
                </div>
                {% endif %}

                <!-- Status-specific content -->
                {% if job.status == 'processing' %}
                <div class="text-center py-4">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Processing...</span>
                    </div>
                    <h5>Generating Your 3D Model</h5>
                    <p class="text-muted">This may take several minutes. Please wait...</p>
                    <button class="btn btn-secondary" onclick="location.reload()">
                        <i data-feather="refresh-cw" class="me-2"></i>
                        Refresh Status
                    </button>
                </div>
                {% elif job.status == 'failed' %}
                <div class="alert alert-danger">
                    <div class="d-flex align-items-center">
                        <i data-feather="alert-triangle" class="me-3"></i>
                        <div>
                            <h6 class="alert-heading mb-2">Generation Failed</h6>
                            <p class="mb-0">{{ job.error_message or 'An unknown error occurred during generation.' }}</p>
                        </div>
                    </div>
                </div>
                <div class="text-center">
                    <a href="{{ url_for('generate') }}" class="btn btn-primary">
                        <i data-feather="repeat" class="me-2"></i>
                        Try Again
                    </a>
                </div>
                {% elif job.status == 'completed' %}
                <!-- Model Features -->
                {% if job.material_style or job.roblox_fixed or job.lod_levels or job.variations %}
                <div class="mb-4">
                    <h5>
                        <i data-feather="star" class="me-2"></i>
                        Model Features
                    </h5>
                    <div class="row g-2">
                        {% if job.material_style %}
                        <div class="col-auto">
                            <span class="badge bg-info">{{ job.material_style }} style</span>
                        </div>
                        {% endif %}
                        {% if job.roblox_fixed %}
                        <div class="col-auto">
                            <span class="badge bg-success">
                                <i data-feather="check-circle" class="me-1"></i>
                                Roblox Ready
                            </span>
                        </div>
                        {% endif %}
                        {% if job.lod_levels %}
                        <div class="col-auto">
                            <span class="badge bg-warning">
                                <i data-feather="layers" class="me-1"></i>
                                LOD Levels
                            </span>
                        </div>
                        {% endif %}
                        {% if job.variations %}
                        <div class="col-auto">
                            <span class="badge bg-primary">
                                <i data-feather="copy" class="me-1"></i>
                                Variations
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Download Links -->
                <div class="row g-3">
                    {% if job.fbx_path %}
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i data-feather="box" style="width: 48px; height: 48px;" class="text-primary"></i>
                                </div>
                                <h5 class="card-title">FBX Format</h5>
                                <p class="card-text text-muted small">
                                    Compatible with Maya, 3ds Max, Unity, Unreal Engine, and more
                                </p>
                                <a href="{{ url_for('download_file', job_id=job.id, file_type='fbx') }}" 
                                   class="btn btn-primary">
                                    <i data-feather="download" class="me-2"></i>
                                    Download FBX
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if job.blend_path %}
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <i data-feather="layers" style="width: 48px; height: 48px;" class="text-info"></i>
                                </div>
                                <h5 class="card-title">Blender Format</h5>
                                <p class="card-text text-muted small">
                                    Native Blender format with full project compatibility
                                </p>
                                <a href="{{ url_for('download_file', job_id=job.id, file_type='blend') }}" 
                                   class="btn btn-info">
                                    <i data-feather="download" class="me-2"></i>
                                    Download BLEND
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>

                <!-- Model Preview (placeholder for future 3D viewer) -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i data-feather="eye" class="me-2"></i>
                            Model Preview
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="py-5">
                            <i data-feather="box" style="width: 64px; height: 64px;" class="text-muted mb-3"></i>
                            <p class="text-muted">3D model preview will be available in a future update</p>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- Actions Card -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-0">Need to generate another model?</h6>
                        <small class="text-muted">Create more 3D models from different prompts</small>
                    </div>
                    <a href="{{ url_for('generate') }}" class="btn btn-outline-primary">
                        <i data-feather="plus" class="me-2"></i>
                        New Generation
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-refresh for processing jobs
{% if job and job.status == 'processing' %}
setTimeout(function() {
    location.reload();
}, 10000); // Refresh every 10 seconds
{% endif %}

// Re-initialize feather icons
feather.replace();
</script>
{% endblock %}
